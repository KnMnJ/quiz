<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <base href="/quiz/quiz.html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>O/X í€´ì¦ˆ</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="O/X í€´ì¦ˆ í•™ìŠµ ì•±">
    <link rel="manifest" href="./manifest.json">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="O/X í€´ì¦ˆ">
    <link rel="apple-touch-icon" href="./apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f1f5f9;
        }

        .ox-btn {
            transition: transform 0.1s;
        }

        .ox-btn:active {
            transform: scale(0.95);
        }

        .blue-text {
            color: #2563eb;
        }

        /* ë§ì•˜ì„ ë•Œ íŒŒë€ìƒ‰ */
        .red-text {
            color: #dc2626;
        }

        /* í‹€ë ¸ì„ ë•Œ ë¹¨ê°„ìƒ‰ */
    </style>
</head>

<body class="flex flex-col min-h-screen">

    <div id="setup-screen" class="p-8 flex-1 flex flex-col justify-center items-center">
        <div class="w-full max-w-md bg-white p-8 rounded-3xl shadow-xl text-center">
            <div class="mb-6 text-5xl">ğŸ“š</div>
            <h1 class="text-2xl font-black mb-2 text-slate-800">í€´ì¦ˆ ì—…ë¡œë“œ</h1>
            <p class="text-sm text-slate-500 mb-8 leading-relaxed">
                '.xlsx' íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.<br>
                (A:ë‹¨ì›, B:ë¬¸ì œ, C:ì •ë‹µ, D:í•´ì„¤)
            </p>

            <label class="block">
                <span class="sr-only">íŒŒì¼ ì„ íƒ</span>
                <input type="file" id="file-input" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-500
                    file:mr-4 file:py-3 file:px-6
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-50 file:text-indigo-700
                    hover:file:bg-indigo-100 cursor-pointer" />
            </label>

            <div id="file-info" class="mt-6 text-sm text-indigo-600 font-bold hidden">
                íŒŒì¼ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!
                <button onclick="startQuiz()"
                    class="w-full mt-4 bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-indigo-200">í€´ì¦ˆ
                    ì‹œì‘í•˜ê¸°</button>
            </div>

            <!-- ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ -->
            <div id="file-history" class="mt-8">
                <h3 class="text-sm font-bold text-slate-600 mb-3">ëª©ë¡</h3>
                <div id="file-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <div id="quiz-screen" class="hidden flex-1 flex flex-col p-6 max-w-md mx-auto w-full">
        <div class="flex justify-between items-center mb-8">
            <div class="bg-indigo-100 px-3 py-1 rounded-full">
                <span id="progress" class="text-indigo-700 text-sm font-bold">1 / 50</span>
            </div>
            <button onclick="location.reload()" class="text-xs text-slate-400">ë©”ì¸ìœ¼ë¡œ</button>
        </div>

        <div class="flex-1 flex flex-col justify-center mb-8 min-h-[200px]">
            <p id="chapter" class="text-sm font-bold text-indigo-400 mb-2"></p>
            <h2 id="question" class="text-2xl font-extrabold text-slate-800 leading-snug break-keep"></h2>
        </div>

        <div id="ox-container" class="grid grid-cols-2 gap-6 mb-10">
            <button onclick="checkAnswer('O')"
                class="ox-btn bg-white border-b-4 border-slate-200 py-10 rounded-3xl text-6xl font-black text-blue-500 shadow-lg">O</button>
            <button onclick="checkAnswer('X')"
                class="ox-btn bg-white border-b-4 border-slate-200 py-10 rounded-3xl text-6xl font-black text-red-500 shadow-lg">X</button>
        </div>

        <div id="explanation-container" class="hidden">
            <div id="result-badge" class="text-center text-4xl font-black mb-6"></div>
            <div class="bg-white p-6 rounded-3xl shadow-inner border border-slate-100">
                <p class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-widest">Description</p>
                <p id="explanation-text" class="text-slate-700 leading-relaxed font-medium"></p>
                <button onclick="nextQuestion()"
                    class="w-full mt-8 bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg">ë‹¤ìŒ ë¬¸ì œë¡œ ></button>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden p-6 max-w-md mx-auto w-full">
        <div class="text-center mb-10 mt-6">
            <h1 class="text-2xl font-black text-slate-800 mb-2">í•™ìŠµ ì™„ë£Œ!</h1>
            <p class="text-6xl font-black text-indigo-600" id="final-score">0 / 50</p>
        </div>

        <div id="capture-area" class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
            <div class="bg-indigo-600 text-white p-4 text-center text-sm font-bold flex items-center justify-between">
                <span class="flex-1">ì˜¤ë‹µ ë…¸íŠ¸</span>
                <button onclick="downloadWrongAnswersImage()"
                    class="bg-white text-indigo-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-50 transition-colors">
                    ğŸ“¥ ì´ë¯¸ì§€ë¡œ ì €ì¥
                </button>
            </div>
            <div class="max-h-[50vh] overflow-y-auto">
                <table class="w-full text-left text-xs border-collapse">
                    <tbody id="wrong-questions-list"></tbody>
                </table>
            </div>
        </div>

        <button onclick="startQuiz()"
            class="w-full mt-8 bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-100">í•œ ë²ˆ ë” í’€ê¸°
            (ëœë¤ 50ë¬¸)</button>
        <button onclick="location.reload()" class="w-full mt-3 text-slate-400 py-2 text-sm font-medium">ë‹¤ë¥¸ íŒŒì¼
            ì—…ë¡œë“œ</button>
    </div>

    <script>
        let allData = [];
        let quizSet = [];
        let currentIndex = 0;
        let score = 0;
        let wrongAnswers = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ ëª©ë¡ í‘œì‹œ ë° ê¸°ë³¸ íŒŒì¼ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', function () {
            // Service Worker ë“±ë¡ (PWA)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker ë“±ë¡ ì„±ê³µ:', reg))
                    .catch(err => console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', err));
            }

            // ê¸°ë³¸ íŒŒì¼ ë¡œë“œ
            loadDefaultFiles();
            displayFileHistory();
        });

        // ê¸°ë³¸ íŒŒì¼ ë¡œë“œ (quiz í´ë”ì˜ 3ê°œ íŒŒì¼)
        async function loadDefaultFiles() {
            const defaultFiles = [
                { name: 'ê²½ì˜.xlsx', path: './ê²½ì˜.xlsx' },
                { name: 'ìƒë²•.xlsx', path: './ìƒë²•.xlsx' },
                { name: 'íšŒê³„.xlsx', path: './íšŒê³„.xlsx' }
            ];

            const history = JSON.parse(localStorage.getItem('quizFileHistory') || '[]');

            // ê¸°ë³¸ íŒŒì¼ì´ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            const hasDefaults = defaultFiles.every(df =>
                history.some(h => h.name === df.name && h.isDefault)
            );

            if (hasDefaults) {
                return; // ì´ë¯¸ ë¡œë“œë¨
            }

            // ê¸°ë³¸ íŒŒì¼ ë¡œë“œ
            for (const file of defaultFiles) {
                try {
                    const response = await fetch(file.path);
                    const arrayBuffer = await response.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    let lastChapter = 'ê¸°íƒ€';
                    const quizData = json.filter(row => row.length >= 2).map(row => {
                        if (row[0] && String(row[0]).trim() !== '') {
                            lastChapter = String(row[0]).trim();
                        }
                        return {
                            chapter: lastChapter,
                            q: row[1],
                            a: String(row[2]).trim().toUpperCase(),
                            desc: row[3] || '-'
                        };
                    });

                    // ê¸°ë³¸ íŒŒì¼ë¡œ ì €ì¥ (isDefault í”Œë˜ê·¸ ì¶”ê°€)
                    saveFileHistory(file.name, quizData, true);
                } catch (err) {
                    console.log(`ê¸°ë³¸ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${file.name}`, err);
                }
            }
        }


        // íŒŒì¼ ê¸°ë¡ ì €ì¥ (í€´ì¦ˆ ë°ì´í„° í¬í•¨)
        function saveFileHistory(fileName, quizData, isDefault = false) {
            let history = JSON.parse(localStorage.getItem('quizFileHistory') || '[]');
            const timestamp = new Date().toLocaleString('ko-KR');

            // ì¤‘ë³µ ì œê±° (ê°™ì€ íŒŒì¼ëª…ì´ ìˆìœ¼ë©´ ì œê±°)
            history = history.filter(item => item.name !== fileName);

            // ìƒˆ íŒŒì¼ì„ ë§¨ ì•ì— ì¶”ê°€ (í€´ì¦ˆ ë°ì´í„° í¬í•¨)
            const fileEntry = {
                name: fileName,
                timestamp: timestamp,
                data: quizData
            };

            if (isDefault) {
                fileEntry.isDefault = true;
            }

            history.unshift(fileEntry);

            // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ ì €ì¥
            if (history.length > 10) {
                history = history.slice(0, 10);
            }

            localStorage.setItem('quizFileHistory', JSON.stringify(history));
            displayFileHistory();
        }

        // íŒŒì¼ ê¸°ë¡ í‘œì‹œ
        function displayFileHistory() {
            const history = JSON.parse(localStorage.getItem('quizFileHistory') || '[]');
            const listContainer = document.getElementById('file-list');

            if (history.length === 0) {
                listContainer.innerHTML = '<p class="text-xs text-slate-400 text-center py-4">ì•„ì§ ì—…ë¡œë“œí•œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listContainer.innerHTML = history.map((item, index) => {
                const fileName = item.name.replace('.xlsx', '');

                if (item.isDefault) {
                    // ê¸°ë³¸ íŒŒì¼: ë‚ ì§œ í‘œì‹œ ì—†ìŒ, ì‚­ì œ ë²„íŠ¼ ì—†ìŒ
                    return `
                        <div class="flex items-center justify-between bg-slate-50 px-4 py-3 rounded-lg text-xs hover:bg-slate-100 transition-colors cursor-pointer" onclick="loadQuizFromHistory(${index})">
                            <p class="font-semibold text-slate-700">${fileName}</p>
                        </div>
                    `;
                } else {
                    // ì‚¬ìš©ì ì—…ë¡œë“œ íŒŒì¼: ë‚ ì§œ í‘œì‹œ, ì‚­ì œ ë²„íŠ¼ ìˆìŒ
                    return `
                        <div class="flex items-center justify-between bg-slate-50 px-4 py-3 rounded-lg text-xs hover:bg-slate-100 transition-colors">
                            <div class="flex-1 min-w-0 cursor-pointer" onclick="loadQuizFromHistory(${index})">
                                <p class="font-semibold text-slate-700 truncate">${item.name}</p>
                                <p class="text-slate-400 text-[10px] mt-0.5">${item.timestamp}</p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteFileHistory(${index})" class="ml-2 text-red-400 hover:text-red-600 font-bold text-sm">Ã—</button>
                        </div>
                    `;
                }
            }).join('');
        }

        // íŒŒì¼ ê¸°ë¡ì—ì„œ í€´ì¦ˆ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadQuizFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('quizFileHistory') || '[]');
            if (history[index] && history[index].data) {
                allData = history[index].data;
                document.getElementById('file-info').classList.remove('hidden');
                // ìë™ìœ¼ë¡œ í€´ì¦ˆ ì‹œì‘
                startQuiz();
            }
        }

        // íŒŒì¼ ê¸°ë¡ ì‚­ì œ
        function deleteFileHistory(index) {
            let history = JSON.parse(localStorage.getItem('quizFileHistory') || '[]');
            history.splice(index, 1);
            localStorage.setItem('quizFileHistory', JSON.stringify(history));
            displayFileHistory();
        }

        // ì—‘ì…€ íŒŒì¼ ì½ê¸° ì²˜ë¦¬
        document.getElementById('file-input').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // ë³‘í•©ëœ ì…€ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë³€ìˆ˜
                let lastChapter = 'ê¸°íƒ€';

                // ë°ì´í„° íŒŒì‹± (ë³‘í•©ëœ ì…€ ì²˜ë¦¬)
                allData = json.filter(row => row.length >= 2).map(row => {
                    // Aì—´(ë‹¨ì›)ì´ ë¹„ì–´ìˆìœ¼ë©´ ì´ì „ ë‹¨ì›ëª… ì‚¬ìš©
                    if (row[0] && String(row[0]).trim() !== '') {
                        lastChapter = String(row[0]).trim();
                    }

                    return {
                        chapter: lastChapter,
                        q: row[1],
                        a: String(row[2]).trim().toUpperCase(),
                        desc: row[3] || '-'
                    };
                });

                if (allData.length > 0) {
                    document.getElementById('file-info').classList.remove('hidden');
                    // íŒŒì¼ ê¸°ë¡ ì €ì¥ (í€´ì¦ˆ ë°ì´í„° í¬í•¨)
                    saveFileHistory(file.name, allData);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function startQuiz() {
            const count = Math.min(allData.length, 50);
            quizSet = [...allData].sort(() => Math.random() - 0.5).slice(0, count);
            currentIndex = 0;
            score = 0;
            wrongAnswers = [];

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            const q = quizSet[currentIndex];
            document.getElementById('progress').innerText = `${currentIndex + 1} / ${quizSet.length}`;
            // ì¤„ë°”ê¿ˆ ì œê±°í•˜ì—¬ í•œ ì¤„ë¡œ í‘œì‹œ
            document.getElementById('chapter').innerText = q.chapter.replace(/[\r\n]+/g, ' ');
            document.getElementById('question').innerText = q.q;
            document.getElementById('ox-container').classList.remove('hidden');
            document.getElementById('explanation-container').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function checkAnswer(userPick) {
            const q = quizSet[currentIndex];
            const isCorrect = userPick === q.a;

            const badge = document.getElementById('result-badge');
            document.getElementById('ox-container').classList.add('hidden');
            document.getElementById('explanation-container').classList.remove('hidden');
            document.getElementById('explanation-text').innerText = q.desc;

            if (isCorrect) {
                score++;
                badge.innerText = "ì •ë‹µ";
                badge.className = "text-center text-3xl font-black mb-6 blue-text"; // íŒŒë€ìƒ‰
            } else {
                badge.innerText = "ì˜¤ë‹µ";
                badge.className = "text-center text-3xl font-black mb-6 red-text"; // ë¹¨ê°„ìƒ‰
                wrongAnswers.push(q);
            }
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < quizSet.length) {
                showQuestion();
            } else {
                showResult();
            }
        }

        function showResult() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${score} / ${quizSet.length}`;

            const listContainer = document.getElementById('wrong-questions-list');
            listContainer.innerHTML = '';

            if (wrongAnswers.length === 0) {
                listContainer.innerHTML = '<tr><td class="p-8 text-center text-slate-500 font-bold text-sm">í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì™„ë²½í•©ë‹ˆë‹¤! ğŸ‘</td></tr>';
            } else {
                wrongAnswers.forEach((q, idx) => {
                    const row = `
                        <tr class="border-b border-slate-100">
                            <td class="p-4 bg-slate-50 font-black text-indigo-400 align-top text-center" style="width: 50px">${idx + 1}</td>
                            <td class="p-4">
                                <div class="font-bold text-slate-800 mb-2 break-keep text-sm">${q.q}</div>
                                <div class="text-slate-500 text-xs leading-relaxed"><span class="font-bold text-red-500 text-xs">[ì •ë‹µ: ${q.a}]</span> ${q.desc}</div>
                            </td>
                        </tr>
                    `;
                    listContainer.innerHTML += row;
                });
            }
            window.scrollTo(0, 0);
        }

        // ì˜¤ë‹µë…¸íŠ¸ ì´ë¯¸ì§€ë¡œ ì €ì¥
        function downloadWrongAnswersImage() {
            const captureArea = document.getElementById('capture-area');
            const scrollContainer = captureArea.querySelector('.max-h-\\[50vh\\]');

            // ìŠ¤í¬ë¡¤ ì œí•œ ì„ì‹œ í•´ì œ (ì „ì²´ ë‚´ìš© ìº¡ì²˜ë¥¼ ìœ„í•´)
            const originalMaxHeight = scrollContainer.style.maxHeight;
            const originalOverflow = scrollContainer.style.overflow;
            scrollContainer.style.maxHeight = 'none';
            scrollContainer.style.overflow = 'visible';

            // html2canvasë¡œ ìº¡ì²˜
            html2canvas(captureArea, {
                backgroundColor: '#ffffff',
                scale: 2, // ê³ í•´ìƒë„
                logging: false,
                useCORS: true,
                windowHeight: captureArea.scrollHeight + 100
            }).then(canvas => {
                // ì›ë˜ ìŠ¤íƒ€ì¼ ë³µì›
                scrollContainer.style.maxHeight = originalMaxHeight;
                scrollContainer.style.overflow = originalOverflow;

                // ìº”ë²„ìŠ¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
                const link = document.createElement('a');
                const timestamp = new Date().toLocaleString('ko-KR').replace(/[/:]/g, '-').replace(/\s/g, '_');
                link.download = `ì˜¤ë‹µë…¸íŠ¸_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì›ë˜ ìŠ¤íƒ€ì¼ ë³µì›
                scrollContainer.style.maxHeight = originalMaxHeight;
                scrollContainer.style.overflow = originalOverflow;

                console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', err);
                alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
    </script>
</body>

</html>